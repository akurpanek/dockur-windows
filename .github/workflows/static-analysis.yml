name: Full Static Analysis with Variable Lint

on:
  push:
  pull_request:

jobs:
  static-analysis:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 0. Checkout repo
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 1. PowerShell Syntax + Strict Mode
      # -----------------------------
      - name: Validate PowerShell scripts
        shell: pwsh
        run: |
          Write-Output "Checking all PS scripts syntax..."
          $psFiles = Get-ChildItem storage/OEM -Recurse -Filter *.ps1
          if ($psFiles.Count -eq 0) { Write-Error "No PS scripts found!"; exit 1 }
          foreach ($file in $psFiles) {
              Write-Output "Validating $($file.FullName)"
              try {
                  pwsh -NoProfile -Command {
                      param($path)
                      Set-StrictMode -Version Latest
                      . $path
                  } -path $file.FullName
              } catch {
                  Write-Error "Syntax/StrictMode error in $($file.FullName)"
                  exit 1
              }
          }

      # -----------------------------
      # 2. PowerShell Variable Lint
      # -----------------------------
      - name: Lint PS Variables
        shell: pwsh
        run: |
          Write-Output "Scanning all PS scripts for undefined or global variables..."
          $psFiles = Get-ChildItem storage/OEM -Recurse -Filter *.ps1
          foreach ($file in $psFiles) {
              Write-Output "Analyzing $($file.FullName)..."
              $lines = Get-Content $file.FullName
              
              # Collect all variables used
              $usedVars = @()
              foreach ($line in $lines) {
                  $matches = [regex]::Matches($line, '\$[A-Za-z_][A-Za-z0-9_]*')
                  foreach ($m in $matches) { $usedVars += $m.Value }
              }
              $usedVars = $usedVars | Sort-Object -Unique

              # Check if variables are assigned anywhere
              foreach ($v in $usedVars) {
                  $assigned = $false
                  foreach ($line in $lines) {
                      if ($line -match "$v\s*=") { $assigned = $true; break }
                  }
                  if (-not $assigned) {
                      Write-Warning "Potential undefined variable $v in $($file.FullName)"
                  }
              }

              # Detect global / script scope usage
              foreach ($v in $usedVars) {
                  foreach ($line in $lines) {
                      if ($line -match "\$(global|script):$($v.Substring(1))") {
                          Write-Warning "Variable $v may use global/script scope in $($file.FullName)"
                      }
                  }
              }
          }

      # -----------------------------
      # 3. Validate ODT config.xml
      # -----------------------------
      - name: Validate ODT config.xml
        shell: pwsh
        run: |
          $configFile = "storage/OEM/ODT/config.xml"
          if (-not (Test-Path $configFile)) { Write-Error "config.xml missing!"; exit 1 }
          try {
              [xml]$xml = Get-Content $configFile
              if (-
